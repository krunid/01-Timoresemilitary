

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ทะเบียนข้อมูลทหารไทยไปติมอร์</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f0f4f8;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
    }
    
    .progress-bar {
      width: 300px;
      height: 10px;
      background-color: #e2e8f0;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress {
      height: 100%;
      background-color: #4f46e5;
      border-radius: 5px;
      transition: width 0.3s ease;
    }
    
    .tab-active {
      background-color: #4f46e5;
      color: white;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .success {
      background-color: #10b981;
    }
    
    .error {
      background-color: #ef4444;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
    }
    
    th, td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background-color: #f8fafc;
      font-weight: 600;
    }
    
    tr:hover {
      background-color: #f1f5f9;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="text-xl mb-2">กำลังดำเนินการ...</div>
    <div class="progress-bar">
      <div id="progress" class="progress" style="width: 0%"></div>
    </div>
  </div>
  
  <!-- Notification -->
  <div id="notification" class="notification"></div>
  
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-800 to-indigo-900 text-white py-6 px-4 shadow-lg">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-center">ทะเบียนข้อมูลทหารไทยไปติมอร์</h1>
      <p class="text-center mt-2 text-blue-100">ระบบจัดการข้อมูลทหารไทยไปติมอร์</p>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">
    <!-- Tabs -->
    <div class="flex mb-6 border rounded-lg overflow-hidden shadow-sm">
      <button id="formTab" class="tab-active flex-1 py-3 text-center font-medium transition-colors duration-200">แบบฟอร์มบันทึกข้อมูล</button>
      <button id="dataTab" class="bg-gray-100 flex-1 py-3 text-center font-medium transition-colors duration-200">ข้อมูลทั้งหมด</button>
    </div>
    
    <!-- Form Section -->
    <section id="formSection" class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">บันทึกข้อมูลทหาร</h2>
      
      <form id="personnelForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">คำนำหน้า/ยศ <span class="text-red-500">*</span></label>
            <div class="relative">
              <select id="title" name="title" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="" disabled selected>เลือกคำนำหน้า/ยศ</option>
                <optgroup label="ทั่วไป">
                  <option value="นาย">นาย</option>
                  <option value="นาง">นาง</option>
                  <option value="นางสาว">นางสาว</option>
                </optgroup>
                <optgroup label="ยศทางทหารเรือ">
                  <option value="พลเรือเอก">พลเรือเอก</option>
                  <option value="พลเรือโท">พลเรือโท</option>
                  <option value="พลเรือตรี">พลเรือตรี</option>
                  <option value="นาวาเอก">นาวาเอก</option>
                  <option value="นาวาโท">นาวาโท</option>
                  <option value="นาวาตรี">นาวาตรี</option>
                  <option value="เรือเอก">เรือเอก</option>
                  <option value="เรือโท">เรือโท</option>
                  <option value="เรือตรี">เรือตรี</option>
                  <option value="พันจ่าเอก">พันจ่าเอก</option>
                  <option value="พันจ่าโท">พันจ่าโท</option>
                  <option value="พันจ่าตรี">พันจ่าตรี</option>
                  <option value="จ่าเอก">จ่าเอก</option>
                  <option value="จ่าโท">จ่าโท</option>
                  <option value="จ่าตรี">จ่าตรี</option>
                </optgroup>
              </select>
              <input type="text" id="customTitle" name="customTitle" placeholder="หรือพิมพ์คำนำหน้า/ยศอื่นๆ" class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" style="display: none;">
            </div>
            <div class="mt-1">
              <label class="inline-flex items-center">
                <input type="checkbox" id="customTitleCheckbox" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <span class="ml-2 text-sm text-gray-600">ระบุคำนำหน้า/ยศอื่นๆ</span>
              </label>
            </div>
          </div>
          
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล <span class="text-red-500">*</span></label>
            <input type="text" id="name" name="name" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          
          <div>
            <label for="birthday" class="block text-sm font-medium text-gray-700 mb-1">วันเดือนปีเกิด <span class="text-red-500">*</span></label>
            <input type="date" id="birthday" name="birthday" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          
          <div>
            <label for="workday" class="block text-sm font-medium text-gray-700 mb-1">วันที่รับราชการ <span class="text-red-500">*</span></label>
            <input type="date" id="workday" name="workday" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทร <span class="text-red-500">*</span></label>
            <input type="tel" id="phone" name="phone" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          
          <div>
            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่ปัจจุบัน <span class="text-red-500">*</span></label>
            <textarea id="address" name="address" required rows="2" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          </div>
          
          <div>
            <label for="idLine" class="block text-sm font-medium text-gray-700 mb-1">ไอดีไลน์</label>
            <input type="text" id="idLine" name="idLine" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          
          <div>
            <label for="fb" class="block text-sm font-medium text-gray-700 mb-1">เฟสบุ๊ค</label>
            <input type="text" id="fb" name="fb" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
          </div>
        </div>
        
        <div>
          <label for="remake" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
          <textarea id="remake" name="remake" rows="2" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>
        
        <div class="pt-4">
          <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
            บันทึกข้อมูล
          </button>
        </div>
      </form>
    </section>
    
    <!-- Data Section -->
    <section id="dataSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">ข้อมูลทั้งหมด</h2>
        <button id="refreshBtn" class="bg-blue-500 text-white py-1 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          รีเฟรช
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr>
              <th>ที่</th>
              <th>รหัสประจำตัว</th>
              <th>ยศ</th>
              <th>ชื่อ-นามสกุล</th>
              <th>วันเกิด</th>
              <th>วันรับราชการ</th>
              <th>เบอร์โทร</th>
              <th>การจัดการ</th>
            </tr>
          </thead>
          <tbody id="dataTable">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <div id="noData" class="text-center py-8 text-gray-500" style="display: none;">
        ไม่พบข้อมูล
      </div>
    </section>
  </main>
  
  <!-- View Modal -->
  <div id="viewModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">รายละเอียดข้อมูล</h3>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="viewModalContent" class="space-y-3">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">แก้ไขข้อมูล</h3>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="editForm" class="space-y-4">
        <input type="hidden" id="editCodePer" name="codePer">
        
        <div>
          <label for="editTitle" class="block text-sm font-medium text-gray-700 mb-1">คำนำหน้า/ยศ <span class="text-red-500">*</span></label>
          <div class="relative">
            <select id="editTitle" name="title" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              <option value="" disabled>เลือกคำนำหน้า/ยศ</option>
              <optgroup label="ทั่วไป">
                <option value="นาย">นาย</option>
                <option value="นาง">นาง</option>
                <option value="นางสาว">นางสาว</option>
              </optgroup>
              <optgroup label="ยศทางทหารเรือ">
                <option value="พลเรือเอก">พลเรือเอก</option>
                <option value="พลเรือโท">พลเรือโท</option>
                <option value="พลเรือตรี">พลเรือตรี</option>
                <option value="นาวาเอก">นาวาเอก</option>
                <option value="นาวาโท">นาวาโท</option>
                <option value="นาวาตรี">นาวาตรี</option>
                <option value="เรือเอก">เรือเอก</option>
                <option value="เรือโท">เรือโท</option>
                <option value="เรือตรี">เรือตรี</option>
                <option value="พันจ่าเอก">พันจ่าเอก</option>
                <option value="พันจ่าโท">พันจ่าโท</option>
                <option value="พันจ่าตรี">พันจ่าตรี</option>
                <option value="จ่าเอก">จ่าเอก</option>
                <option value="จ่าโท">จ่าโท</option>
                <option value="จ่าตรี">จ่าตรี</option>
              </optgroup>
            </select>
            <input type="text" id="editCustomTitle" name="customTitle" placeholder="หรือพิมพ์คำนำหน้า/ยศอื่นๆ" class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" style="display: none;">
          </div>
          <div class="mt-1">
            <label class="inline-flex items-center">
              <input type="checkbox" id="editCustomTitleCheckbox" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
              <span class="ml-2 text-sm text-gray-600">ระบุคำนำหน้า/ยศอื่นๆ</span>
            </label>
          </div>
        </div>
        
        <div>
          <label for="editName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล <span class="text-red-500">*</span></label>
          <input type="text" id="editName" name="name" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
          <label for="editBirthday" class="block text-sm font-medium text-gray-700 mb-1">วันเดือนปีเกิด <span class="text-red-500">*</span></label>
          <input type="date" id="editBirthday" name="birthday" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
          <label for="editWorkday" class="block text-sm font-medium text-gray-700 mb-1">วันที่รับราชการ <span class="text-red-500">*</span></label>
          <input type="date" id="editWorkday" name="workday" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
          <label for="editPhone" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทร <span class="text-red-500">*</span></label>
          <input type="tel" id="editPhone" name="phone" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
          <label for="editAddress" class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่ปัจจุบัน <span class="text-red-500">*</span></label>
          <textarea id="editAddress" name="address" required rows="2" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>
        
        <div>
          <label for="editIdLine" class="block text-sm font-medium text-gray-700 mb-1">ไอดีไลน์</label>
          <input type="text" id="editIdLine" name="idLine" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
          <label for="editFb" class="block text-sm font-medium text-gray-700 mb-1">เฟสบุ๊ค</label>
          <input type="text" id="editFb" name="fb" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
          <label for="editRemake" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
          <textarea id="editRemake" name="remake" rows="2" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>
        
        <div>
          <label for="editPassword" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน <span class="text-red-500">*</span></label>
          <input type="password" id="editPassword" name="password" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div class="pt-4">
          <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
            บันทึกการแก้ไข
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Delete Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">ยืนยันการลบข้อมูล</h3>
        <button class="close-modal text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p class="mb-4">คุณต้องการลบข้อมูลของ <span id="deletePersonName" class="font-semibold"></span> ใช่หรือไม่?</p>
      <p class="mb-4 text-red-500">การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
      
      <form id="deleteForm" class="space-y-4">
        <input type="hidden" id="deleteCodePer" name="codePer">
        
        <div>
          <label for="deletePassword" class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน <span class="text-red-500">*</span></label>
          <input type="password" id="deletePassword" name="password" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div class="flex space-x-3 pt-2">
          <button type="button" class="close-modal flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200">
            ยกเลิก
          </button>
          <button type="submit" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
            ลบข้อมูล
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbzZeHjzim5fX93qghEbpNo_i3FGmHZSCfhhZr1lnGE0lvW7JBeylb5nc-TYLbZwYXz6cQ/exec';
    
    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const progressBar = document.getElementById('progress');
    const notification = document.getElementById('notification');
    const formTab = document.getElementById('formTab');
    const dataTab = document.getElementById('dataTab');
    const formSection = document.getElementById('formSection');
    const dataSection = document.getElementById('dataSection');
    const personnelForm = document.getElementById('personnelForm');
    const refreshBtn = document.getElementById('refreshBtn');
    const dataTable = document.getElementById('dataTable');
    const noData = document.getElementById('noData');
    
    // Custom Title Checkbox
    const customTitleCheckbox = document.getElementById('customTitleCheckbox');
    const title = document.getElementById('title');
    const customTitle = document.getElementById('customTitle');
    
    // Edit Custom Title Checkbox
    const editCustomTitleCheckbox = document.getElementById('editCustomTitleCheckbox');
    const editTitle = document.getElementById('editTitle');
    const editCustomTitle = document.getElementById('editCustomTitle');
    
    // Modals
    const viewModal = document.getElementById('viewModal');
    const editModal = document.getElementById('editModal');
    const deleteModal = document.getElementById('deleteModal');
    const closeModalButtons = document.querySelectorAll('.close-modal');
    
    // Forms
    const editForm = document.getElementById('editForm');
    const deleteForm = document.getElementById('deleteForm');
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Check if the sheet exists
      checkSheet();
      
      // Set up event listeners
      setupEventListeners();
    });
    
    // Check if the sheet exists
    function checkSheet() {
      showLoading();
      
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'checkSheet'
        }),
        headers: {
          'Content-Type': 'text/plain'
        }
      })
      .then(response => response.json())
      .then(data => {
        hideLoading();
        if (data.success) {
          showNotification('ระบบพร้อมใช้งาน', 'success');
        } else {
          showNotification('เกิดข้อผิดพลาดในการตรวจสอบชีท: ' + data.message, 'error');
        }
      })
      .catch(error => {
        hideLoading();
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
      });
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Tab switching
      formTab.addEventListener('click', () => {
        formTab.classList.add('tab-active');
        formTab.classList.remove('bg-gray-100');
        dataTab.classList.remove('tab-active');
        dataTab.classList.add('bg-gray-100');
        formSection.style.display = 'block';
        dataSection.style.display = 'none';
      });
      
      dataTab.addEventListener('click', () => {
        dataTab.classList.add('tab-active');
        dataTab.classList.remove('bg-gray-100');
        formTab.classList.remove('tab-active');
        formTab.classList.add('bg-gray-100');
        dataSection.style.display = 'block';
        formSection.style.display = 'none';
        loadData();
      });
      
      // Custom title checkbox
      customTitleCheckbox.addEventListener('change', function() {
        if (this.checked) {
          title.style.display = 'none';
          customTitle.style.display = 'block';
          title.removeAttribute('required');
          customTitle.setAttribute('required', '');
        } else {
          title.style.display = 'block';
          customTitle.style.display = 'none';
          title.setAttribute('required', '');
          customTitle.removeAttribute('required');
        }
      });
      
      // Edit custom title checkbox
      editCustomTitleCheckbox.addEventListener('change', function() {
        if (this.checked) {
          editTitle.style.display = 'none';
          editCustomTitle.style.display = 'block';
          editTitle.removeAttribute('required');
          editCustomTitle.setAttribute('required', '');
        } else {
          editTitle.style.display = 'block';
          editCustomTitle.style.display = 'none';
          editTitle.setAttribute('required', '');
          editCustomTitle.removeAttribute('required');
        }
      });
      
      // Form submission
      personnelForm.addEventListener('submit', handleFormSubmit);
      
      // Refresh button
      refreshBtn.addEventListener('click', loadData);
      
      // Edit form submission
      editForm.addEventListener('submit', handleEditFormSubmit);
      
      // Delete form submission
      deleteForm.addEventListener('submit', handleDeleteFormSubmit);
      
      // Close modal buttons
      closeModalButtons.forEach(button => {
        button.addEventListener('click', () => {
          viewModal.style.display = 'none';
          editModal.style.display = 'none';
          deleteModal.style.display = 'none';
        });
      });
      
      // Close modals when clicking outside
      window.addEventListener('click', (event) => {
        if (event.target === viewModal) {
          viewModal.style.display = 'none';
        }
        if (event.target === editModal) {
          editModal.style.display = 'none';
        }
        if (event.target === deleteModal) {
          deleteModal.style.display = 'none';
        }
      });
    }
    
    // Handle form submission
    function handleFormSubmit(event) {
      event.preventDefault();
      
      // Get form data
      const formData = new FormData(personnelForm);
      const data = {
        action: 'addRecord',
        title: customTitleCheckbox.checked ? formData.get('customTitle') : formData.get('title'),
        name: formData.get('name'),
        birthday: formData.get('birthday'),
        workday: formData.get('workday'),
        phone: formData.get('phone'),
        address: formData.get('address'),
        idLine: formData.get('idLine'),
        fb: formData.get('fb'),
        remake: formData.get('remake')
      };
      
      // Validate required fields
      if (!data.title || !data.name || !data.birthday || !data.workday || !data.phone || !data.address) {
        showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return;
      }
      
      // Submit data
      submitData(data);
    }
    
    // Submit data to API
    function submitData(data) {
      showLoading();
      
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'text/plain'
        }
      })
      .then(response => response.json())
      .then(result => {
        hideLoading();
        
        if (result.success) {
          showNotification(result.message, 'success');
          personnelForm.reset();
          
          // Switch to data tab and refresh data
          dataTab.click();
        } else {
          showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
        }
      })
      .catch(error => {
        hideLoading();
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
      });
    }
    
    // Load data from API
    function loadData() {
      showLoading();
      
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'getRecords'
        }),
        headers: {
          'Content-Type': 'text/plain'
        }
      })
      .then(response => response.json())
      .then(result => {
        hideLoading();
        
        if (result.success) {
          renderData(result.data);
        } else {
          showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + result.message, 'error');
        }
      })
      .catch(error => {
        hideLoading();
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
      });
    }
    
    // Render data to table
    function renderData(data) {
      dataTable.innerHTML = '';
      
      if (data.length === 0) {
        noData.style.display = 'block';
        return;
      }
      
      noData.style.display = 'none';
      
      data.forEach(item => {
        const row = document.createElement('tr');
        
        // Format dates
        const birthday = formatDate(item.birthday);
        const workday = formatDate(item.workday);
        
        row.innerHTML = `
          <td>${item.no}</td>
          <td>${item.Code_per}</td>
          <td>${item.title}</td>
          <td>${item.name}</td>
          <td>${birthday}</td>
          <td>${workday}</td>
          <td>${item.phone}</td>
          <td class="flex space-x-2">
            <button class="view-btn bg-blue-500 text-white py-1 px-2 rounded-md hover:bg-blue-600 text-xs" data-id="${item.Code_per}">ดู</button>
            <button class="edit-btn bg-yellow-500 text-white py-1 px-2 rounded-md hover:bg-yellow-600 text-xs" data-id="${item.Code_per}">แก้ไข</button>
            <button class="delete-btn bg-red-500 text-white py-1 px-2 rounded-md hover:bg-red-600 text-xs" data-id="${item.Code_per}" data-name="${item.title} ${item.name}">ลบ</button>
          </td>
        `;
        
        dataTable.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => viewRecord(btn.dataset.id, data));
      });
      
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => editRecord(btn.dataset.id, data));
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('deletePersonName').textContent = btn.dataset.name;
          document.getElementById('deleteCodePer').value = btn.dataset.id;
          deleteModal.style.display = 'flex';
        });
      });
    }
    
    // View record details
    function viewRecord(id, data) {
      const record = data.find(item => item.Code_per === id);
      
      if (!record) {
        showNotification('ไม่พบข้อมูลที่ต้องการ', 'error');
        return;
      }
      
      // Format dates
      const birthday = formatDate(record.birthday);
      const workday = formatDate(record.workday);
      const timestamp = record.timestamp;
      
      const content = document.getElementById('viewModalContent');
      content.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          <div class="text-gray-600">รหัสประจำตัว:</div>
          <div class="font-medium">${record.Code_per}</div>
          
          <div class="text-gray-600">ยศ/คำนำหน้า:</div>
          <div class="font-medium">${record.title}</div>
          
          <div class="text-gray-600">ชื่อ-นามสกุล:</div>
          <div class="font-medium">${record.name}</div>
          
          <div class="text-gray-600">วันเดือนปีเกิด:</div>
          <div class="font-medium">${birthday}</div>
          
          <div class="text-gray-600">วันที่รับราชการ:</div>
          <div class="font-medium">${workday}</div>
          
          <div class="text-gray-600">เบอร์โทร:</div>
          <div class="font-medium">${record.phone}</div>
          
          <div class="text-gray-600">ที่อยู่ปัจจุบัน:</div>
          <div class="font-medium">${record.address}</div>
          
          <div class="text-gray-600">ไอดีไลน์:</div>
          <div class="font-medium">${record.idLine || '-'}</div>
          
          <div class="text-gray-600">เฟสบุ๊ค:</div>
          <div class="font-medium">${record.fb || '-'}</div>
          
          <div class="text-gray-600">หมายเหตุ:</div>
          <div class="font-medium">${record.remake || '-'}</div>
          
          <div class="text-gray-600">วันที่บันทึก:</div>
          <div class="font-medium">${timestamp}</div>
        </div>
      `;
      
      viewModal.style.display = 'flex';
    }
    
    // Edit record
    function editRecord(id, data) {
      const record = data.find(item => item.Code_per === id);
      
      if (!record) {
        showNotification('ไม่พบข้อมูลที่ต้องการแก้ไข', 'error');
        return;
      }
      
      // Check if the title is in the dropdown options
      const titleOptions = Array.from(editTitle.options).map(option => option.value);
      const isCustomTitle = !titleOptions.includes(record.title);
      
      // Set form values
      document.getElementById('editCodePer').value = record.Code_per;
      
      if (isCustomTitle) {
        editCustomTitleCheckbox.checked = true;
        editTitle.style.display = 'none';
        editCustomTitle.style.display = 'block';
        editTitle.removeAttribute('required');
        editCustomTitle.setAttribute('required', '');
        editCustomTitle.value = record.title;
      } else {
        editCustomTitleCheckbox.checked = false;
        editTitle.style.display = 'block';
        editCustomTitle.style.display = 'none';
        editTitle.setAttribute('required', '');
        editCustomTitle.removeAttribute('required');
        editTitle.value = record.title;
      }
      
      document.getElementById('editName').value = record.name;
      
      // Format date for input (YYYY-MM-DD)
      const birthdayDate = formatDateForInput(record.birthday);
      const workdayDate = formatDateForInput(record.workday);
      
      document.getElementById('editBirthday').value = birthdayDate;
      document.getElementById('editWorkday').value = workdayDate;
      document.getElementById('editPhone').value = record.phone;
      document.getElementById('editAddress').value = record.address;
      document.getElementById('editIdLine').value = record.idLine || '';
      document.getElementById('editFb').value = record.fb || '';
      document.getElementById('editRemake').value = record.remake || '';
      
      editModal.style.display = 'flex';
    }
    
    // Handle edit form submission
    function handleEditFormSubmit(event) {
      event.preventDefault();
      
      // Get form data
      const formData = new FormData(editForm);
      const data = {
        action: 'updateRecord',
        codePer: formData.get('codePer'),
        title: editCustomTitleCheckbox.checked ? formData.get('customTitle') : formData.get('title'),
        name: formData.get('name'),
        birthday: formData.get('birthday'),
        workday: formData.get('workday'),
        phone: formData.get('phone'),
        address: formData.get('address'),
        idLine: formData.get('idLine'),
        fb: formData.get('fb'),
        remake: formData.get('remake'),
        password: formData.get('password')
      };
      
      // Validate required fields
      if (!data.title || !data.name || !data.birthday || !data.workday || !data.phone || !data.address || !data.password) {
        showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return;
      }
      
      // Submit data
      showLoading();
      
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'text/plain'
        }
      })
      .then(response => response.json())
      .then(result => {
        hideLoading();
        
        if (result.success) {
          showNotification(result.message, 'success');
          editModal.style.display = 'none';
          loadData();
        } else {
          showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
        }
      })
      .catch(error => {
        hideLoading();
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
      });
    }
    
    // Handle delete form submission
    function handleDeleteFormSubmit(event) {
      event.preventDefault();
      
      // Get form data
      const formData = new FormData(deleteForm);
      const data = {
        action: 'deleteRecord',
        codePer: formData.get('codePer'),
        password: formData.get('password')
      };
      
      // Validate required fields
      if (!data.codePer || !data.password) {
        showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
        return;
      }
      
      // Submit data
      showLoading();
      
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'text/plain'
        }
      })
      .then(response => response.json())
      .then(result => {
        hideLoading();
        
        if (result.success) {
          showNotification(result.message, 'success');
          deleteModal.style.display = 'none';
          loadData();
        } else {
          showNotification('เกิดข้อผิดพลาด: ' + result.message, 'error');
        }
      })
      .catch(error => {
        hideLoading();
        showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
      });
    }
    
    // Show loading overlay
    function showLoading() {
      loadingOverlay.style.display = 'flex';
      
      // Simulate progress
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) {
          progress = 90;
          clearInterval(interval);
        }
        progressBar.style.width = progress + '%';
      }, 200);
      
      // Store the interval ID
      loadingOverlay.dataset.intervalId = interval;
    }
    
    // Hide loading overlay
    function hideLoading() {
      // Clear the interval
      clearInterval(parseInt(loadingOverlay.dataset.intervalId));
      
      // Complete the progress bar
      progressBar.style.width = '100%';
      
      // Hide the overlay after a short delay
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
        progressBar.style.width = '0%';
      }, 300);
    }
    
    // Show notification
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }
    
    // Format date (DD/MM/YYYY)
    function formatDate(dateString) {
      if (!dateString) return '-';
      
      // Check if the date is already in DD/MM/YYYY format
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
        return dateString;
      }
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
      } catch (error) {
        return dateString;
      }
    }
    
    // Format date for input (YYYY-MM-DD)
    function formatDateForInput(dateString) {
      if (!dateString) return '';
      
      try {
        // Check if the date is in DD/MM/YYYY format
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
          const parts = dateString.split('/');
          return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
        
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        
        return `${year}-${month}-${day}`;
      } catch (error) {
        return '';
      }
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'94e7fe9ab5b2a183',t:'MTc0OTcxNzExNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
